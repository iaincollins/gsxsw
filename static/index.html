<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
	<script type="text/javascript" src="socket.io.js"></script> 
	<script type="text/javascript">
	// functions...
	var client = { };
	client.display = function (channelName, data) {
		$("#messages").append('channel name: ' + channelName + ' : ' + data.message+'<br/>');
	};

	$(function () {
		// awful
		var host = new String(document.location).split('/')[2];
		
		// using custom events.
		var socket;
		$("input.connect").click(function () {
			socket = new io.Socket(host);
			socket.connect();
			socket.on('connect', function(){ $(document).trigger("connected"); });
			socket.on('message', function(data){ $(document).trigger("message", data); });
			socket.on('disconnect', function(){ $(document).trigger("disconnected"); });
		});
		$("input.disconnect").click(function () {
			socket.disconnect();
		});
		$("input.send").click(function () { 
			socket.send(JSON.stringify(["push", "Default", { 'message' : $("input.message").val(), 'important' : false, 'repost' : false }]));
		});
		// connection/disconnection : custom events.
		$(document).bind("disconnected", function () {
			$("input.connect").show(); $("#panel").hide();
		});
		// 
		$(document).bind("connected", function () {
			$("input.connect").hide(); $("#panel").show();
			// registering default channel
			socket.send(JSON.stringify(["register", "Default"]));
			// pulling default channel
			socket.send(JSON.stringify(["pull", "Default", 40]));
		});
		$(document).bind("message", function (e, data) {
			data = JSON.parse(data);
			if (data.length > 0) {
				console.log(data);
				var f = data.shift();
				client[f].apply(client, data);
			}
		});
	});
	</script>
</head>
<body>
	<input value="connect" type="button" class="connect"/>
	<div id="panel" style="display:none">
		message : <input class="message" type="text"/><input type="button" value="send" class="send"/><br/>
		<input type="button" value="disconnect" class="disconnect"/><br/>
		<br/>
		<div id="messages" style="border: 3px solid #555555;">
			
		</div>
	</div>
</body>
</html>